<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>EaglercraftX 启动器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            background: #ffffff; /* 整体白色背景 */
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* 4:3比例的矩形按钮 */
        #launch-btn {
            width: 320px; /* 4:3比例（320×240） */
            height: 240px;
            background: #e0e0e0; /* 淡灰色背景 */
            border: none;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s ease, background 0.2s ease;
        }
        #launch-btn:hover {
            transform: scale(1.02);
            background: #d5d5d5; /* hover时稍深灰色 */
        }
        /* 1:1比例的矩形加号 - 横条 */
        #launch-btn::before {
            content: '';
            position: absolute;
            width: 60px;
            height: 12px;
            background: #ffffff; /* 白色加号 */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        /* 1:1比例的矩形加号 - 竖条 */
        #launch-btn::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 60px;
            background: #ffffff; /* 白色加号 */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        /* 状态提示（隐藏，选择文件时显示） */
        .status-message {
            position: absolute;
            color: #666666;
            font-family: Arial, sans-serif;
            font-size: 14px;
            display: none;
        }
        /* 游戏容器 */
        #game-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
            display: none;
        }
    </style>
</head>
<body>
    <!-- 隐藏的文件选择器 -->
    <input type="file" id="core-file" accept=".js" style="display: none;">
    
    <!-- 中央按钮 -->
    <button id="launch-btn"></button>
    
    <!-- 状态提示 -->
    <div class="status-message" id="status"></div>

    <!-- 游戏容器 -->
    <div id="game-container"></div>

    <script>
        window.eaglercraftXOpts = {
            container: "game-container",
            worldsDB: "eagler_worlds",
            enableSound: true
        };

        const launchBtn = document.getElementById('launch-btn');
        const fileInput = document.getElementById('core-file');
        const statusDisplay = document.getElementById('status');
        const gameContainer = document.getElementById('game-container');

        // 点击按钮直接触发文件选择
        launchBtn.addEventListener('click', function() {
            fileInput.click(); // 直接弹出文件选择窗
        });

        // 文件选择后自动启动游戏
        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                const selectedFile = e.target.files[0];
                statusDisplay.textContent = '正在加载游戏核心...';
                statusDisplay.style.display = 'block';
                
                // 隐藏按钮，显示加载状态
                launchBtn.style.display = 'none';
                
                // 启动游戏
                overrideSelectors();
                handleFileAndLaunch(selectedFile);
            }
        });

        function overrideSelectors() {
            const originalQ = document.querySelector;
            const originalG = document.getElementById;
            
            document.querySelector = function(selector) {
                return document.getElementById('game-container') || document.body;
            };
            
            document.getElementById = function(id) {
                return id === 'game-container' ? gameContainer : document.body;
            };
        }

        function handleFileAndLaunch(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    // 显示游戏容器
                    gameContainer.style.display = 'block';
                    statusDisplay.textContent = '正在初始化游戏...';

                    const script = document.createElement('script');
                    script.textContent = e.target.result;
                    
                    script.onload = function() {
                        if (window.initEaglercraftX) {
                            window.initEaglercraftX({
                                ...window.eaglercraftXOpts,
                                container: gameContainer,
                                width: window.innerWidth,
                                height: window.innerHeight
                            });

                            // 监听窗口大小变化
                            window.addEventListener('resize', () => {
                                if (window.eaglercraftX && window.eaglercraftX.resize) {
                                    window.eaglercraftX.resize(window.innerWidth, window.innerHeight);
                                }
                            });
                            
                            // 隐藏状态提示
                            statusDisplay.style.display = 'none';
                        } else {
                            alert('错误：未找到游戏初始化函数');
                            resetUI(); // 重置界面
                        }
                    };
                    
                    script.onerror = function() {
                        alert('错误：游戏核心执行失败');
                        resetUI(); // 重置界面
                    };
                    
                    document.body.appendChild(script);
                } catch (err) {
                    alert(`加载错误: ${err.message}`);
                    console.error(err);
                    resetUI(); // 重置界面
                }
            };
            
            reader.onerror = function() {
                alert(`文件读取错误: ${reader.error.message}`);
                resetUI(); // 重置界面
            };
            
            reader.readAsText(file);
        }

        // 错误时重置界面
        function resetUI() {
            statusDisplay.style.display = 'none';
            launchBtn.style.display = 'block';
            fileInput.value = ''; // 清空文件选择
        }
    </script>
</body>
</html>
